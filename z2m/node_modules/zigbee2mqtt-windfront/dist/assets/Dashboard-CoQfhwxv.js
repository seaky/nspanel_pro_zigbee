import{j as r,b as D,r as _,c as q,C as A,E as z,F as V,G as T,a as u,A as I,d as $,t as k,g as E,N as M,I as R}from"./index-BFQ_Rrcw.js";import{u as G,b as B}from"./useColumnCount-BbLlvyFs.js";import{D as O}from"./DeviceCard-0gRlLdCT.js";import{R as L}from"./RemoveDeviceModal-BE8nZkGo.js";import{D as W}from"./DashboardFeatureWrapper--hzUpPRy.js";import{u as P,T as U}from"./useTable-BacTGfa3.js";import"./envs-CSqIi4cL.js";import"./Feature-Cii_Ps_h.js";import"./DisplayValue-ZtlRXdX7.js";import"./isObject--vsEa_js.js";import"./_createCompounder-BUW0VzD-.js";import"./isArray-BNsEL_P3.js";import"./index-BWCKKOXu.js";import"./LastSeen-BEZqgdEU.js";import"./format-C1E149BK.js";import"./Lqi-DNnUR2fS.js";import"./PowerSource-B3Yl2iYL.js";import"./snakeCase-BilpKH8r.js";import"./DeviceImage-DYpYz5SI.js";import"./index-CoqysZeI.js";import"./CheckboxField-CaA8YhTd.js";import"./DebouncedInput-DbVQn5vN.js";const H=({original:{sourceIdx:a,device:n,deviceState:p,deviceAvailability:c,features:l,lastSeenConfig:y,removeDevice:v}})=>{const{t:h}=D("zigbee"),w=_.useCallback(async f=>{await q(a,`${n.ieee_address}/set`,f)},[a,n.ieee_address]);return r.jsx("div",{className:`mb-3 card bg-base-200 rounded-box shadow-md ${c==="disabled"?"card-dash border-warning/40":c==="offline"?"card-border border-error/50":"card-border border-base-300"}`,children:r.jsx(O,{features:l,sourceIdx:a,device:n,deviceState:p,onChange:w,featureWrapperClass:W,lastSeenConfig:y,children:r.jsx("div",{className:"join join-horizontal",children:r.jsx(A,{onClick:async()=>await z.show(L,{sourceIdx:a,device:n,removeDevice:v}),className:"btn btn-outline btn-error btn-square btn-sm join-item tooltip-left",title:h(f=>f.remove_device),children:r.jsx(V,{icon:T})})})})})},J=a=>a?.data?r.jsx(H,{...a.data}):null;function he(){const{t:a}=D(["common","zigbee"]),n=u(e=>e.deviceStates),p=u(e=>e.availability),c=u(e=>e.deviceDashboardFeatures),l=u(e=>e.bridgeInfo),y=u(e=>e.devices),v=G(),h=_.useCallback(async(e,t,d,j)=>{await q(e,"bridge/request/device/remove",{id:t,force:d,block:j})},[]),w=_.useMemo(()=>{const e=[];for(let t=0;t<I.length;t++){const d=l[t].config.advanced.last_seen,j=l[t].config.availability.enabled;for(const i of y[t]){if(i.disabled||!i.supported||!i.definition)continue;const F=c[t][i.ieee_address];if(!F||F.length===0)continue;const g=new Set,C=new Set;for(const s of F)if("features"in s&&s.features){for(const b of s.features)b.type&&g.add(b.type),b.name&&C.add(b.name);s.type&&g.add(s.type)}else s.type&&g.add(s.type),s.name&&C.add(s.name);const o=n[t][i.friendly_name]??{};let m;i.power_source==="Battery"&&(m=!1,"battery"in o?o.battery<20&&(m=!0):"battery_state"in o?o.battery_state==="low"&&(m=!0):"battery_low"in o&&(m=!!o.battery_low));let N="disabled";if(!i.disabled){const s=l[t].config.devices[i.ieee_address]?.availability;N=(s!=null?!!s:void 0)??j?p[t][i.friendly_name]?.state??"offline":"disabled"}e.push({sourceIdx:t,device:i,deviceState:o,deviceAvailability:N,batteryLow:m,features:F,featureTypes:Array.from(g),featureNames:Array.from(C),lastSeenConfig:d,removeDevice:h})}}return e},[y,n,c,l,p,h]),f=_.useMemo(()=>[{id:"source",accessorFn:({sourceIdx:e})=>$[e],filterFn:"equals",meta:{filterVariant:"select",showFacetedOccurrences:!0}},{id:"friendly_name",header:a(e=>e.friendly_name),accessorFn:({device:e})=>`${e.friendly_name} ${e.description??""}`,sortingFn:(e,t)=>e.original.device.friendly_name.localeCompare(t.original.device.friendly_name),filterFn:"includesString",meta:{filterVariant:"text",textFaceted:!0}},{id:"ieee_address",header:a(e=>e.ieee_address,{ns:"zigbee"}),accessorFn:({device:e})=>`${e.ieee_address} ${k(e.network_address,4)} ${e.network_address}`,filterFn:"includesString",meta:{filterVariant:"text"}},{id:"availability",header:a(e=>e.availability,{ns:"availability"}),accessorFn:({deviceAvailability:e})=>a(t=>t[e],{ns:"availability"}),filterFn:"equals",meta:{filterVariant:"select",showFacetedOccurrences:!0}},{id:"type",header:a(e=>e.type,{ns:"zigbee"}),accessorFn:({device:e})=>a(t=>t[e.type],{ns:"zigbee"}),filterFn:"equals",meta:{filterVariant:"select",showFacetedOccurrences:!0}},{id:"state",header:a(e=>e.state),accessorFn:({deviceState:e})=>e.state,filterFn:"equals",meta:{filterVariant:"select",showFacetedOccurrences:!0}},{id:"lqi",header:a(e=>e.lqi,{ns:"zigbee"}),accessorFn:({deviceState:e})=>e.linkquality,filterFn:"inNumberRange",meta:{filterVariant:"range"}},{id:"last_seen",header:a(e=>e.last_seen,{ns:"zigbee"}),accessorFn:({deviceState:e,lastSeenConfig:t})=>{const d=E(e.last_seen,t);return d?Math.round((Date.now()-d)/1e3/60):void 0},enableGlobalFilter:!1,filterFn:"inNumberRange",meta:{filterVariant:"range",tooltip:a(e=>e.last_seen_filter_info)}},{id:"battery_low",header:a(e=>e.battery_low,{ns:"zigbee"}),accessorFn:({batteryLow:e})=>e===void 0?"N/A":e,filterFn:"equals",meta:{filterVariant:"boolean"}},{id:"feature_type",header:a(e=>e.feature_type),accessorFn:({featureTypes:e})=>e,filterFn:"arrIncludes",meta:{filterVariant:"arrSelect"},enableGlobalFilter:!1},{id:"feature_name",header:a(e=>e.feature_name),accessorFn:({featureNames:e})=>e,filterFn:"arrIncludes",meta:{filterVariant:"arrSelect"},enableGlobalFilter:!1}],[a]),x=P({id:"dashboard-devices",columns:f,data:w,sorting:[{id:"friendly_name",desc:!1}]}),{rows:S}=x.table.getRowModel();return r.jsxs(r.Fragment,{children:[r.jsx(M,{children:r.jsx(U,{...x})}),r.jsx("div",{children:r.jsx(B,{useWindowScroll:!0,columnCount:v,data:S,ItemContent:J,className:"gap-3"},`dashboard-${S.length}-${x.globalFilter}`)}),r.jsx("div",{className:"sticky z-9 bottom-0 pb-1 w-full flex flex-row justify-end sm:hidden",children:r.jsx(A,{title:a(e=>e.scroll_to_top),className:"btn btn-primary btn-square",onClick:()=>{window.scrollTo(0,0)},children:r.jsx(V,{icon:R})})})]})}export{he as default};
