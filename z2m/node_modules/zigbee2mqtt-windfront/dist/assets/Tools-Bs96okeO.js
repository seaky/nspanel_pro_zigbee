import{E as k,P as _,b as f,r as m,j as a,Q as h,C as l,c as g,a as u,k as p,aW as y,T as x,da as C}from"./index-BFQ_Rrcw.js";import{I as N}from"./InputField-CIKw2Xrr.js";import{g as v}from"./index-CoqysZeI.js";import"./envs-CSqIi4cL.js";const z=k.create(t=>{const{addInstallCode:o}=t,s=_(),{t:i}=f(["settings","common"]),[r,c]=m.useState("");return m.useEffect(()=>{const n=d=>{d.key==="Escape"&&(d.preventDefault(),s.remove())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[s]),a.jsx(h,{isOpen:s.visible,title:i(n=>n.add_install_code),footer:a.jsxs(a.Fragment,{children:[a.jsx(l,{className:"btn btn-neutral",onClick:s.remove,children:i(n=>n.cancel,{ns:"common"})}),a.jsx(l,{className:"btn btn-primary ms-1",onClick:async()=>{r&&(s.remove(),await o(r))},children:i(n=>n.add_install_code)})]}),children:a.jsx("div",{className:"flex flex-col gap-2",children:a.jsx(N,{name:"install_code",label:i(n=>n.install_code),onChange:n=>c(n.target.value),value:r,type:"text",required:!0})})})});async function S(t){return await new Promise((o,s)=>{const i=new FileReader;i.onloadend=()=>o(i.result),i.onerror=r=>s(r),i.readAsDataURL(t)})}async function E(t){const o=await fetch(t);if(o.ok){const s=await o.blob();return await S(s)}return Promise.reject(o.status)}function q({sourceIdx:t,devices:o}){const[s,i]=m.useState("none"),[r,c]=m.useState({}),{t:n}=f(["settings","common","zigbee"]),d=m.useCallback(async e=>{c(w=>({...w,[e.ieee_address]:"init"}));const b=v(e),j=await E(b);return await g(t,"bridge/request/device/options",{id:e.ieee_address,options:{icon:j}}),c(w=>({...w,[e.ieee_address]:"done"})),!0},[t]);switch(m.useEffect(()=>{if(s==="start"){for(const e of o)e.type!=="Coordinator"&&d(e).catch(b=>{console.error("Error localising image",b),c(j=>({...j,[e.ieee_address]:"error"}))}).then();i("inprogress")}},[s,o,d]),s){case"none":return a.jsx(l,{className:"btn btn-outline btn-primary join-item",onClick:()=>i("start"),children:n(e=>e.localise_images)});case"inprogress":return a.jsx("ul",{className:"menu menu-xs bg-base-200 max-w-xs w-full join-item",children:o.map(e=>a.jsxs("li",{className:"flex-row justify-between items-center border-b py-0.5",children:[e.friendly_name,a.jsx("span",{className:"badge badge-xs",children:n(b=>b[r[e.ieee_address]],{ns:"common"})})]},`${t}-${e.ieee_address}-${e.friendly_name}`))});case"done":return a.jsx("div",{children:n(e=>e.unknown,{ns:"zigbee"})})}return a.jsx("div",{children:n(e=>e.unknown,{ns:"zigbee"})})}function A({sourceIdx:t}){const o=u(e=>e.setBackupPreparing),s=u(p(e=>e.bridgeInfo[t])),i=u(p(e=>e.backup[t])),r=u(p(e=>e.preparingBackup[t])),c=u(p(e=>e.devices[t])),{t:n}=f(["settings","common"]),d=m.useCallback(()=>{const e=`z2m-backup.${s.version}.${Date.now()}.zip`;y(`data:application/zip;base64,${i}`,e)},[i,s.version]);return a.jsxs("div",{className:"join join-vertical",children:[a.jsx(x,{className:"btn btn-outline btn-error join-item mb-2",onClick:async()=>await g(t,"bridge/request/restart",""),title:n(e=>e.restart_zigbee2mqtt),modalDescription:n(e=>e.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:n(e=>e.cancel,{ns:"common"}),children:n(e=>e.restart_zigbee2mqtt)}),a.jsx(l,{className:"btn btn-outline btn-primary join-item",onClick:async()=>await C(u.getState(),"state.json"),children:n(e=>e.download_state)}),r?a.jsx(l,{className:"btn btn-primary join-item disabled",children:a.jsx("span",{className:"loading loading-dots loading-xl"})}):i?a.jsx(l,{className:"btn btn-outline btn-primary join-item",onClick:d,children:n(e=>e.download_z2m_backup)}):a.jsx(l,{className:"btn btn-outline btn-primary join-item",onClick:async()=>{o(t),await g(t,"bridge/request/backup","")},children:n(e=>e.request_z2m_backup)}),a.jsx(l,{className:"btn btn-outline btn-primary join-item",onClick:async()=>await k.show(z,{addInstallCode:async e=>await g(t,"bridge/request/install_code/add",{value:e})}),children:n(e=>e.add_install_code)}),a.jsx(q,{sourceIdx:t,devices:c})]})}export{A as default};
